(function($){"use strict";var Utils=$.fn.bootstrapTable.utils;$.extend($.fn.bootstrapTable.defaults,{usePipeline:false,pipelineSize:1e3,onCachedDataHit:function(data){return false},onCachedDataReset:function(data){return false}});$.extend($.fn.bootstrapTable.Constructor.EVENTS,{"cached-data-hit.bs.table":"onCachedDataHit","cached-data-reset.bs.table":"onCachedDataReset"});var BootstrapTable=$.fn.bootstrapTable.Constructor,_init=BootstrapTable.prototype.init,_initServer=BootstrapTable.prototype.initServer,_onSearch=BootstrapTable.prototype.onSearch,_onSort=BootstrapTable.prototype.onSort,_onPageListChange=BootstrapTable.prototype.onPageListChange;BootstrapTable.prototype.init=function(){this.initPipeline();_init.apply(this,Array.prototype.slice.apply(arguments))};BootstrapTable.prototype.initPipeline=function(){this.cacheRequestJSON={};this.cacheWindows=[];this.currWindow=0;this.resetCache=true};BootstrapTable.prototype.onSearch=function(event){if(this.options.usePipeline){this.resetCache=true}_onSearch.apply(this,Array.prototype.slice.apply(arguments))};BootstrapTable.prototype.onSort=function(event){if(this.options.usePipeline){this.resetCache=true}_onSort.apply(this,Array.prototype.slice.apply(arguments))};BootstrapTable.prototype.onPageListChange=function(event){var target=$(event.currentTarget);var newPageSize=parseInt(target.text());this.options.pipelineSize=this.calculatePipelineSize(this.options.pipelineSize,newPageSize);this.resetCache=true;_onPageListChange.apply(this,Array.prototype.slice.apply(arguments))};BootstrapTable.prototype.calculatePipelineSize=function(pipelineSize,pageSize){if(pageSize==0)return 0;return Math.ceil(pipelineSize/pageSize)*pageSize};BootstrapTable.prototype.setCacheWindows=function(){this.cacheWindows=[];var numWindows=this.options.totalRows/this.options.pipelineSize;for(var i=0;i<=numWindows;i++){var b=i*this.options.pipelineSize;this.cacheWindows[i]={lower:b,upper:b+this.options.pipelineSize-1}}};BootstrapTable.prototype.setCurrWindow=function(offset){this.currWindow=0;for(var i=0;i<this.cacheWindows.length;i++){if(this.cacheWindows[i].lower<=offset&&offset<=this.cacheWindows[i].upper){this.currWindow=i;break}}};BootstrapTable.prototype.drawFromCache=function(offset,limit){var res=$.extend(true,{},this.cacheRequestJSON);var drawStart=offset-this.cacheWindows[this.currWindow].lower;var drawEnd=drawStart+limit;res.rows=res.rows.slice(drawStart,drawEnd);return res};BootstrapTable.prototype.initServer=function(silent,query,url){var data={};var index=this.header.fields.indexOf(this.options.sortName);var params={searchText:this.searchText,sortName:this.options.sortName,sortOrder:this.options.sortOrder};var request=null;if(this.header.sortNames[index]){params.sortName=this.header.sortNames[index]}if(this.options.pagination&&this.options.sidePagination==="server"){params.pageSize=this.options.pageSize===this.options.formatAllRows()?this.options.totalRows:this.options.pageSize;params.pageNumber=this.options.pageNumber}if(!(url||this.options.url)&&!this.options.ajax){return}var useAjax=true;if(this.options.queryParamsType==="limit"){params={searchText:params.searchText,sortName:params.sortName,sortOrder:params.sortOrder};if(this.options.pagination&&this.options.sidePagination==="server"){params.limit=this.options.pageSize===this.options.formatAllRows()?this.options.totalRows:this.options.pageSize;params.offset=(this.options.pageSize===this.options.formatAllRows()?this.options.totalRows:this.options.pageSize)*(this.options.pageNumber-1);if(this.options.usePipeline){if(!this.cacheWindows.length){useAjax=true;params.drawOffset=params.offset}else{var w=this.cacheWindows[this.currWindow];if(this.resetCache||(params.offset<w.lower||params.offset>w.upper)){useAjax=true;this.setCurrWindow(params.offset);params.drawOffset=params.offset;params.offset=this.cacheWindows[this.currWindow].lower}else{useAjax=false}}}else{if(params.limit===0){delete params.limit}}}}if(this.resetCache){useAjax=true;this.resetCache=false}if(this.options.usePipeline&&useAjax){params.drawLimit=params.limit;params.limit=this.options.pipelineSize}if(!useAjax){var res=this.drawFromCache(params.offset,params.limit);this.load(res);this.trigger("load-success",res);this.trigger("cached-data-hit",res);return}if(!$.isEmptyObject(this.filterColumnsPartial)){params.filter=JSON.stringify(this.filterColumnsPartial,null)}data=Utils.calculateObjectValue(this.options,this.options.queryParams,[params],data);$.extend(data,query||{});if(data===false){return}if(!silent){this.$tableLoading.show()}var self=this;request=$.extend({},Utils.calculateObjectValue(null,this.options.ajaxOptions),{type:this.options.method,url:url||this.options.url,data:this.options.contentType==="application/json"&&this.options.method==="post"?JSON.stringify(data):data,cache:this.options.cache,contentType:this.options.contentType,dataType:this.options.dataType,success:function(res){res=Utils.calculateObjectValue(self.options,self.options.responseHandler,[res],res);if(self.options.usePipeline){self.cacheRequestJSON=$.extend(true,{},res);self.options.totalRows=res[self.options.totalField];self.setCacheWindows();self.setCurrWindow(params.drawOffset);res=self.drawFromCache(params.drawOffset,params.drawLimit);self.trigger("cached-data-reset",res)}self.load(res);self.trigger("load-success",res);if(!silent)self.$tableLoading.hide()},error:function(res){var data=[];if(self.options.sidePagination==="server"){data={};data[self.options.totalField]=0;data[self.options.dataField]=[]}self.load(data);self.trigger("load-error",res.status,res);if(!silent)self.$tableLoading.hide()}});if(this.options.ajax){Utils.calculateObjectValue(this,this.options.ajax,[request],null)}else{if(this._xhr&&this._xhr.readyState!==4){this._xhr.abort()}this._xhr=$.ajax(request)}};$.fn.bootstrapTable.methods.push()})(jQuery);
